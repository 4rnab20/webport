---
title: Matplotlib Demo
author: Arnab Das
date: 4/21/2024
format:
  html:
    code-fold: true
jupyter:
  kernelspec:
    display_name: R
    language: R
    name: ir
---

# Diabetes Prediction Modeling: Exploring Risk Factors


## Introduction:


Diabetes is a prevalent chronic metabolic disorder posing significant health and economic burdens globally, particularly with the recent rise in type 2 diabetes cases. Predictive modeling offers a valuable approach for identifying individuals at risk and intervening early. The dataset we analyze in this project exclusively consists of female patients aged 21 years or above, all of whom are of Pima Indian heritage. These demographic constraints ensure a focused examination of diabetes within this specific population subset. Diagnostic measurements crucial for diabetes prediction, including glucose levels, blood pressure, insulin levels, and BMI were collected through medical examinations and tests conducted by healthcare professionals. Our aim is to develop an effective tool for diabetes risk assessment to gain insights into the factors contributing to its onset, ultimately improving health outcomes and quality of life for individuals vulnerable to diabetes.


#### Data Overview:

  The dataset originates from the National Institute of Diabetes and Digestive and Kidney Diseases and is utilized to **predict the probability of diabetes diagnosis in female subjects aged 21 and above**. There are a total of **768 observations** and **9 variables** in the dataset. The **target variable** is `Outcome` which indicates the presence of diabetes. The **8 explanatory variables** are: `Pregnancies`, `Glucose`, `BloodPressure`, `Skin Thickness`, `Insulin`, `BMI`, `DiabetesPredigreeFunction` and `Age`. Below are the detailed description of each explanatory varibles:

- `Pregnancies`: **Integer** variable indicating the number of pregnancies the individual has experienced.
- `Glucose`: **Numeric** variable representing plasma glucose concentration at 2 hours in an oral glucose tolerance test, measured in **mg/dL**.
- `BloodPressure`: **Numeric** variable denoting the diastolic blood pressure, measured in **mmHg**.
- `Skin Thickness`: **Numeric** variable indicating the thickness of the triceps skin fold, measured in **mm**.
- `Insulin`: **Numeric** variable representing insulin levels in the bloodstream two hours after a specific event (such as the administration of glucose), measured in **micro-units per milliliter** of serum.
- `BMI`: **Numeric** variable representing Body Mass Index (BMI), a measure of body fat based on height and weight, measured in **kg/m^2**.
- `DiabetesPedigreeFunction`: **Numeric** variable representing a function which scores the likelihood of diabetes based on family history.
- `Age`: **Integer** variable indicating the age of the individual.
- `Outcome`: **Categorical (binary)** variable, where **0 represents absence** of diabetes and **1 represents presence** of diabetes. This variable is the **target variable** for prediction.

#### Project Objective:

The primary objective of this project is to develop a predictive model capable for predicting the probability of a subject having diabetes based on their diagnostic measurements. By variable and model selection, we aim to build a **"best"** model for prediction among all candidate models. Through this exploration, we seek to gain insights into the underlying factors contributing to diabetes onset and create a valuable tool for diabetes risk assessment. Further analysis, such as correlation analysis, could contribute to ensuring the reliability and robustness of the observed relationships.


```{r}
#| id: m9r8ZJtW8TN8
#| id: m9r8ZJtW8TN8
#| vscode: {languageId: r}
# install.packages("GGally")
# install.packages("glmnet")
# install.packages("caret")
# install.packages("MASS")
# install.packages("pROC")
# install.packages("cowplot")

# ~ 15 min
```

```{r}
#| id: f320e74f-f267-4ee0-b756-d002819ececc
#| colab: {base_uri: 'https://localhost:8080/'}
#| id: f320e74f-f267-4ee0-b756-d002819ececc
#| outputId: 7e5580bc-2d22-4d7d-cbfd-0e898aa55b82
#| vscode: {languageId: r}
# Load necessary packages
library(tidyverse)
library(ggplot2)
library(GGally)
library(glmnet)
library(caret)
library(MASS)
library(pROC)
library(cowplot)
```

#### Loading data:

```{r}
#| id: 360cd8cf-a968-4dda-80e5-8b0faa4bfb60
#| colab: {base_uri: 'https://localhost:8080/', height: 303}
#| id: 360cd8cf-a968-4dda-80e5-8b0faa4bfb60
#| outputId: bb3b0c95-f250-476d-f15e-db60f2c01800
#| vscode: {languageId: r}
diabetes <- read.csv("diabetes.csv")
head(diabetes)
nrow(diabetes)
```

#### Removing missing values:
Missing values can introduce bias in parameter estimates and reduce their precision. Upon observing that several attributes in our dataset contain missing values, we opted to clean the data by removing these rows.

```{r}
#| id: b2be937a-691f-4fe3-9b96-9863862dd593
#| colab: {base_uri: 'https://localhost:8080/', height: 356}
#| id: b2be937a-691f-4fe3-9b96-9863862dd593
#| outputId: e296892e-ef4f-42ec-db0b-0b60e7fdabee
#| vscode: {languageId: r}
diabetes_clean <- diabetes[!(diabetes$Glucose == 0 | diabetes$BloodPressure == 0 | diabetes$SkinThickness == 0 | diabetes$Insulin == 0 | diabetes$BMI == 0 | diabetes$DiabetesPedigreeFunction == 0 | diabetes$Age == 0), ]
head(diabetes_clean)
nrow(diabetes_clean)
outcome_counts <- table(diabetes_clean$Outcome)
print(outcome_counts)
```

#### Post data-cleaning overview:
The **number of rows** in our dataset after removing the 0 values is **392**. Although the dataset size has decreased, the remaining data still provides sufficient information to explore relationships, trends, and patterns. By excluding rows with unreliable physiological measurements, we ensure the integrity and accuracy of the dataset, allowing for more reliable insights and interpretations from subsequent analyses.  

From some basic exploratory data analysis we see the dataset contains around **one-third** **positive (1)** outcomes, and **two-thirds** **negative (0)** outomes, they are generally balanced enough. However, it's important to remain vigilant for potential issues related to class imbalance and to employ appropriate techniques if imbalance becomes problematic during analysis.

## Methods and Results:

### Exploratory Data Analysis (EDA):
Before delving into specifics, it's essential to examine the overall distribution of outcomes across variables. This exploration provides insight into how outcomes vary in response to changes in each variable.

#### Distribution of predictors:

The density plots for the variables in this dataset illustrate the distribution of each variable's values. This visualization helps in understanding the spread, central tendency, and shape of the data for variables such as Pregnancies, Glucose, BloodPressure, Skin Thickness, Insulin, BMI, DiabetesPedigreeFunction, and Age. These plots offer insights into the prevalence and distribution of key factors associated with diabetes diagnosis in the female subjects aged 21 and above.

```{r}
#| id: s4vk6GmquOgi
#| colab: {base_uri: 'https://localhost:8080/', height: 617}
#| id: s4vk6GmquOgi
#| outputId: bda27d03-c01c-4191-83af-537a421a42f8
#| vscode: {languageId: r}
data_long <- diabetes_clean %>%
  pivot_longer(cols = -Outcome, names_to = "Variable", values_to = "Value")


options(repr.plot.width = 15, repr.plot.height = 10)
density_plot <- ggplot(data_long, aes(x = Value, fill = Variable)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ Variable, scales = "free", nrow = 2, ncol = 4) +
  theme_minimal() +
  ggtitle("Density Plots of Factors") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 25),
        text = element_text(size = 15)) +
  guides(fill = "none")

density_plot
```

#### Understanding the distributions:
Age skews right, indicating a younger population. Blood Pressure and BMI are normally distributed, representing the population. DiabetesPedigreeFunction and Insulin skew right, with low values prevalent; Glucose is normally distributed; Pregnancies skew right, suggesting fewer are common; Skin Thickness is nearly normal, peaking at lower values. These patterns aid in understanding population demographics and physiological factors influencing diabetes prediction.


#### Explore the multicollinearity:
According to regression assumptions, multicollinearity among explanatory variables should be avoided. If a multicollinearity problem exists in the dataset, the standard errors of estimated coefficients will be inflated, and coefficient estimates will be unstable, making it difficult to determine variable significance. Additionally, the interpretation of coefficients will be misleading. We can explore the correlation matrix for better insights.

```{r}
#| id: 5TwF1EGjgkdc
#| colab: {base_uri: 'https://localhost:8080/', height: 917}
#| id: 5TwF1EGjgkdc
#| outputId: 8eefaf69-307b-47bb-b25f-5bb654b4a27c
#| vscode: {languageId: r}
# getting correlation values between variables
corr_matrix <- diabetes_clean %>%
  dplyr::select(- Outcome) %>%
  cor() %>%
  as.data.frame() %>%
  rownames_to_column("var1") %>%
  pivot_longer(-var1, names_to = "var2", values_to = "corr")

# plotting a correlation matrix
options(repr.plot.width = 15, repr.plot.height = 15)
corr_matrix %>%
  ggplot(aes(var1, var2)) +
  geom_tile(aes(fill = corr), color = "white") +
  scale_fill_distiller("Correlation Coefficient \n",
    palette =  "Spectral",
    direction = 1, limits = c(-1,1)
  ) +
    theme(
        axis.text.x = element_text(
          angle = 45, vjust = 1,
          size = 18, hjust = 1
        ),
        axis.text.y = element_text(
          vjust = 1,
          size = 18, hjust = 1
        ),
        title = element_text(size = 20, face = "bold"),
        legend.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 20),
        legend.key.size = unit(2, "cm"),
        text = element_text(size = 20),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 25)
      ) +
      coord_fixed() +
      geom_text(aes(var1, var2, label = round(corr, 2)), color = "black", size = 6) +
    labs(title = "Correlation Matrix")
```

#### Understanding variables which show correlation:

In the dataset analysis, several pairs of variables show significant correlations. Notably, `Glucose` and `Insulin` correlate at **0.58**, indicating a regulatory response to blood sugar levels. `Age` and `Pregnancies` exhibit a correlation of **0.68**, reflecting reproductive aging. `BMI` and `SkinThickness` correlate at **0.66**, suggesting a link between body fat and skin thickness. `BloodPressure` and `BMI` show a correlation of **0.30**, indicating a connection between hypertension and obesity. Lastly, `Glucose` and `Age` correlate at **0.34**, potentially indicating age-related changes in glucose metabolism and diabetes risk. The above all shows the potential issue of multicollinearity in the dataset.

Conversely, the correlation between other variables appears to be within acceptable ranges, suggesting that they are not significantly affected by multicollinearity. Therefore, we need to addresse multicollinearity issue by some techniques such as variable selection or regularization methods,improving the robustness of the regression model.

#### Observing the relationship between each predictor variable and the outcome:

We aim to gain insights into the relationship between each explanatory variable and the response variable before conducting regression analysis. Given the binary nature of the response variable, utilizing boxplots to visualize the relationship between each explanatory variable and the response variable offers a convenient approach.

```{r}
#| id: 6f9ad2e0-8337-401a-a42b-18be2cb220be
#| colab: {base_uri: 'https://localhost:8080/', height: 917}
#| id: 6f9ad2e0-8337-401a-a42b-18be2cb220be
#| outputId: 149430d8-8f6e-4828-8606-9d7336394f35
#| vscode: {languageId: r}
function_plot <- ggplot(data = diabetes_clean, aes(x = factor(Outcome), y =DiabetesPedigreeFunction, fill = factor(Outcome))) +
  geom_boxplot(colour = "red") +
  labs(title = "DiabetesPedigreeFunction vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Diabetes Pedigree Function") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  ) +
  scale_fill_brewer(palette = "Reds", labels = c("0" = "No Diabetes", "1" = "Diabetes"))+
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

Skin_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =SkinThickness, fill = factor(Outcome))) +
  geom_boxplot(colour = "purple") +
  labs(title = "Skin Thickness vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Skin Thickness") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
) +
  scale_fill_brewer(palette = "PuRd", labels = c("0" = "No Diabetes", "1" = "Diabetes"))+
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

glucose_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =Glucose, fill = factor(Outcome))) +
  geom_boxplot(colour = "blue") +
  labs(title = "Glucose vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Glucose Level") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  ) +
  scale_fill_brewer(palette = "Blues", labels = c("0" = "No Diabetes", "1" = "Diabetes"))+
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

bloodPressure_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =BloodPressure, fill = factor(Outcome))) +
  geom_boxplot(colour = "red") +
  labs(title = "Blood Pressure vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Blood Pressure") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  ) +
  scale_fill_brewer(palette = "RdPu", labels = c("0" = "No Diabetes", "1" = "Diabetes"))+
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

Insulin_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =Insulin, fill = factor(Outcome))) +
  geom_boxplot(colour = "darkgreen") +
  labs(title = "Insulin vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Insulin") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  )  +
  scale_fill_brewer(palette = "BuGn", labels = c("0" = "No Diabetes", "1" = "Diabetes"))+
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

BMI_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =BMI, fill = factor(Outcome))) +
  geom_boxplot(colour = "darkgreen") +
  labs(title = "BMI vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Body Mass Index")  + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  )  +
  scale_fill_brewer(palette = "Greens", labels = c("0" = "No Diabetes", "1" = "Diabetes")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

Age_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =Age, fill = factor(Outcome))) +
  geom_boxplot(colour = "red") +
  labs(title = "Age vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Age")  + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  )  +
  scale_fill_brewer(palette = "OrRd", labels = c("0" = "No Diabetes", "1" = "Diabetes")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

Pregnancies_plot <- ggplot(data = diabetes_clean, aes(x = as.factor(Outcome), y =Pregnancies, fill = factor(Outcome))) +
  geom_boxplot(colour = "DarkBlue") +
  labs(title = "Pregnancies vs. Outcome",
       x = "Diabetes Diagnosis",
       y = "Number of Pregnancies") + theme(
    text = element_text(size = 20),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 15)
  )  +
  scale_fill_brewer(palette = "BuPu", labels = c("0" = "No Diabetes", "1" = "Diabetes")) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(text = element_text(size = 15))

combined_plot <- plot_grid(function_plot, Skin_plot, glucose_plot, bloodPressure_plot, Insulin_plot, BMI_plot, Age_plot, Pregnancies_plot, nrow = 2, ncol = 4)

options(repr.plot.width = 20, repr.plot.height = 15)
plot_grid(ggdraw() + draw_label("Diabetes Outcome Across Key Factors", fontface='bold', size = 25), combined_plot, ncol=1, rel_heights=c(0.1, 1))
```

#### Conclusion from boxplots:
* From the eight boxplots above, a notable disparity emerges in the mean glucose levels between individuals with and without diabetes. Specifically, the mean glucose level appears markedly higher among those with diabetes compared to those without, suggesting a positive association between glucose level and diabetes. Given this observation, further investigation into the relationship between glucose level and diabetes outcome is warranted.

* Moreover, upon inspecting the boxplot depicting diabetes status against age, a similar pattern emerges. Individuals diagnosed with diabetes have a higher mean age compared to those without. Consequently, it can be inferred that both age and glucose level are potentially significant explanatory variables associated with diabetes outcome.

* Additionally, it's noteworthy that the mean values of other variables exhibit slight variations based on whether individuals have diabetes or not. Specifically, when an individual has diabetes, the mean values of all eight predictor variables are higher compared to when the person doesn't have diabetes, suggesting a potentially positive relationship between each X and Y to some extent.

### Methods (plan):

#### Model selection methods:
  
* We will begin with a full model incorporating all eight variables, then use backward selection based on AIC and BIC to refine our model selection. This process yields two models: an AIC-selected model and a BIC-selected model. Backward selection eliminates a non-significant predictor from the model in each interaction, resulting in an interpretable final model. AIC and BIC serve as suitable selection criteria due to the binary nature of the response variable in our dataset. Unlike adjusted $R^2$ or residual mean square, AIC and BIC focus on maximizing the likelihood of the data while penalizing model complexity. For comparision, AIC emphasizes maximizing the likelihood, BIC adds a higher penalty for decreasing model complexity, favoring a more straightforward and simpler model.

* Given the objective of setting up a model for prediction, avoiding model overfitting and reducing the variance of estimated cofficients are important concerns we need to consider. To address this concern, LASSO regression gives us a great advantage in terms of effectively shrinking some coefficients to zero, thereby increasing the model’s generalizability to out-of-sample data. Therefore, we will also incorporate a LASSO regression model into our analysis to serve as another candidate model.

* We will compare the predictive performance of four candidate models: the full model, AIC-selected model, BIC-selected model, and LASSO model. After splitting the data into training and testing subsets, we will build up each model using the training dataset and evaluate their performance based on AUC values. The model with the highest AUC value was selected as the final model. We will then assess the generalization ability of the final model by fitting it to the testing dataset and computing the AUC value. Using a probability threshold of 0.5, we classify individuals as "1" or "0" accordingly. Additionally, we will compute confusion matrices and evaluated metrics such as Accuracy and Precision to determine the best model for predicting diabetes status. This comprehensive approach allows us to identify the most effective model for our predictive task.



#### Implementation of a proposed model:

* **Spliting the data into training set and testing set:**

```{r}
#| id: b1aa7ee7-316b-457b-873f-f91ae2bf49fd
#| colab: {base_uri: 'https://localhost:8080/', height: 52}
#| id: b1aa7ee7-316b-457b-873f-f91ae2bf49fd
#| outputId: c0e03e9c-ce87-402a-f56f-dbb15151b9d1
#| vscode: {languageId: r}
set.seed(123)
training.samples <- diabetes_clean$Outcome %>%
  createDataPartition(p = 0.7, list = FALSE)
diabetes_train  <- diabetes_clean[training.samples, ]
diabetes_test <- diabetes_clean[-training.samples, ]
nrow(diabetes_train)
nrow(diabetes_test)
```

* **Fit the full logistic regression model using training dataset:**

```{r}
#| id: fd54c79b-5d09-4c18-b62a-b36a49b3aa4e
#| colab: {base_uri: 'https://localhost:8080/', height: 451}
#| id: fd54c79b-5d09-4c18-b62a-b36a49b3aa4e
#| outputId: 234ac9d0-508f-44dc-ed40-8702da728b06
#| vscode: {languageId: r}
full_model <- glm(formula = Outcome ~ ., family = binomial, data = diabetes_train)
summary(full_model)
```

* **Backward selection based on AIC to get a AIC-selected model:**

```{r}
#| id: 9b0d5943-34da-4c1c-bcfc-3d6c9f29938a
#| colab: {base_uri: 'https://localhost:8080/', height: 1000}
#| id: 9b0d5943-34da-4c1c-bcfc-3d6c9f29938a
#| outputId: 06ea0c55-52d4-47e1-8f72-394171384796
#| vscode: {languageId: r}
AIC_selection <- stepAIC(full_model, method = "backward")
AIC_selection
```

```{r}
#| id: 5bddd652-edc7-4deb-90fb-4d2a3a68080f
#| colab: {base_uri: 'https://localhost:8080/', height: 399}
#| id: 5bddd652-edc7-4deb-90fb-4d2a3a68080f
#| outputId: 753e922a-4cd3-40dd-f696-5f7eb53f7adb
#| vscode: {languageId: r}
AIC_model <- glm(formula = Outcome ~ DiabetesPedigreeFunction + Age + BMI + Glucose, family = binomial, data = diabetes_train)
summary(AIC_model)
```

* **Backward selection based on BIC to get a BIC-selected model:**

```{r}
#| id: f332f756-f574-463e-9dc0-02fba486aeb6
#| colab: {base_uri: 'https://localhost:8080/', height: 208}
#| id: f332f756-f574-463e-9dc0-02fba486aeb6
#| outputId: bf02914d-0342-459e-d0aa-cf21e79c9ea6
#| vscode: {languageId: r}
BIC_selection <- step(full_model, direction = "backward", k = log(nrow(diabetes_clean)), trace = FALSE)
BIC_selection
```

```{r}
#| id: 67946808-47a5-4689-9b63-196d7d692dbf
#| colab: {base_uri: 'https://localhost:8080/', height: 382}
#| id: 67946808-47a5-4689-9b63-196d7d692dbf
#| outputId: 92d6a1e4-b8be-4c32-ab7d-27f454e03721
#| vscode: {languageId: r}
BIC_model <- glm(formula = Outcome ~ Age + BMI + Glucose, family = binomial, data = diabetes_train)
summary(BIC_model)
```

* **Compute three confusion matrics for full model, AIC-selected model and BIC-selected model seperately:**

```{r}
#| id: a46104f4-a7e1-4d45-b4f1-693537a79336
#| colab: {base_uri: 'https://localhost:8080/', height: 486}
#| id: a46104f4-a7e1-4d45-b4f1-693537a79336
#| outputId: 3738ff74-4826-40cc-e81a-53c1f23e9444
#| vscode: {languageId: r}
diabetes_pred_class_full_model <-
  round(predict(full_model, type = "response"), 0)
diabetes_confusion_matrix <-
    confusionMatrix(
    data = as.factor(diabetes_pred_class_full_model),
    reference = as.factor(diabetes_train$Outcome),
    positive = '1'
)

diabetes_confusion_matrix
```

```{r}
#| id: cea02d74-5ee3-4c7d-8403-6547bde52b1b
#| colab: {base_uri: 'https://localhost:8080/', height: 486}
#| id: cea02d74-5ee3-4c7d-8403-6547bde52b1b
#| outputId: e626e893-6368-422b-bc2c-52fc507e0979
#| vscode: {languageId: r}
diabetes_pred_class_AIC_model <-
  round(predict(AIC_model, type = "response"), 0)

diabetes_confusion_matrix_AIC_model <-
    confusionMatrix(
    data = as.factor(diabetes_pred_class_AIC_model),
    reference = as.factor(diabetes_train$Outcome),
    positive = '1'
)

diabetes_confusion_matrix_AIC_model
```

```{r}
#| id: da98fcc4-c33b-4967-827f-5318c387e01e
#| colab: {base_uri: 'https://localhost:8080/', height: 486}
#| id: da98fcc4-c33b-4967-827f-5318c387e01e
#| outputId: 2e22083f-9348-4e0d-de30-ddae5d4272c2
#| vscode: {languageId: r}
diabetes_pred_class_BIC_model <-
  round(predict(BIC_model, type = "response"), 0)

diabetes_confusion_matrix_BIC_model <-
    confusionMatrix(
    data = as.factor(diabetes_pred_class_BIC_model),
    reference = as.factor(diabetes_train$Outcome),
    positive = '1'
)

diabetes_confusion_matrix_BIC_model
```

* **Get AUC values for these 3 candidate models:**

```{r}
#| id: 8974bf26-1f53-49c0-83dd-f48dc4d6c77a
#| colab: {base_uri: 'https://localhost:8080/'}
#| id: 8974bf26-1f53-49c0-83dd-f48dc4d6c77a
#| outputId: 51768dda-e1e5-4896-bdba-32f9d0ad7281
#| vscode: {languageId: r}
ROC_full_log <- roc(
  response = diabetes_train$Outcome,
  predictor = predict(full_model, type = "response")
)
cat("Full model AUC value:", ROC_full_log$auc)

ROC_AIC_log <- roc(
  response = diabetes_train$Outcome,
  predictor = predict(AIC_model, type = "response")
)
cat("AIC-selected model AUC value:", ROC_AIC_log$auc)

ROC_BIC_log <- roc(
  response = diabetes_train$Outcome,
  predictor = predict(BIC_model, type = "response")
)
cat("BIC-selected model AUC value:", ROC_BIC_log$auc)
```

* **Using LASSO to get a logistic regression model and compare the prediction performance of LASSO model with those 3 models above.**

```{r}
#| id: fce71538-cafc-4a0c-aaf0-10d7c59fc2eb
#| id: fce71538-cafc-4a0c-aaf0-10d7c59fc2eb
#| vscode: {languageId: r}
model_matrix_X_train <-
    as.matrix(diabetes_train[, -9])

matrix_Y_train <-
    as.matrix(diabetes_train[, 9], ncol = 1)
```

```{r}
#| id: 65f6ebed-6d39-434a-b140-56d3e58807ce
#| colab: {base_uri: 'https://localhost:8080/', height: 156}
#| id: 65f6ebed-6d39-434a-b140-56d3e58807ce
#| outputId: 5f50fd7d-3218-4c83-daed-745eff67493c
#| vscode: {languageId: r}
#set.seed(271)
diabetes_cv_lambda_LASSO <-
  cv.glmnet(
  x = model_matrix_X_train, y = matrix_Y_train,
  alpha = 1,
  family = 'binomial',
  type.measure = 'auc',
  nfolds = 5)

diabetes_cv_lambda_LASSO
#plot(diabetes_cv_lambda_LASSO, main = "Cross-Validation with LASSO\n\n")
```

```{r}
#| id: c11230bd-632c-4df2-a209-514dd5f5543b
#| colab: {base_uri: 'https://localhost:8080/', height: 34}
#| id: c11230bd-632c-4df2-a209-514dd5f5543b
#| outputId: 6d15cfdd-fe52-4b78-f6e7-ae9a7fd12219
#| vscode: {languageId: r}
diabetes_lambda_1se_AUC_LASSO <- round(diabetes_cv_lambda_LASSO$lambda.1se, 4)

diabetes_lambda_1se_AUC_LASSO
```

```{r}
#| id: 8d804fc8-16b7-497c-9c14-83b5341f518c
#| colab: {base_uri: 'https://localhost:8080/', height: 208}
#| id: 8d804fc8-16b7-497c-9c14-83b5341f518c
#| outputId: 6e832a8c-28e1-429f-cdb4-d7d5264f371f
#| vscode: {languageId: r}
diabetes_LASSO_1se_AUC <- glmnet(
  x = model_matrix_X_train, y = matrix_Y_train,
  alpha = 1,
  family = 'binomial',
  lambda = diabetes_lambda_1se_AUC_LASSO
)
coef(diabetes_LASSO_1se_AUC)
```

```{r}
#| id: 5c57be0a-12a8-4ffe-a67d-e9b46a7f0067
#| colab: {base_uri: 'https://localhost:8080/', height: 191}
#| id: 5c57be0a-12a8-4ffe-a67d-e9b46a7f0067
#| outputId: e429ec6a-7989-49d7-ad24-56d812b00740
#| vscode: {languageId: r}
ROC_lasso <-
    roc(
        response = diabetes_train$Outcome,
        predictor = predict(diabetes_LASSO_1se_AUC,
                     newx = model_matrix_X_train)[,"s0"] )
ROC_lasso
AUC_lasso <- pROC::auc(ROC_lasso)
```

* **Compare the AUC values for our 4 candidate models, full model, AIC-selected model, BIC-selected model and LASSO model.**

```{r}
#| id: 293aea4f-70a8-47de-9058-1baf160aef3d
#| colab: {base_uri: 'https://localhost:8080/', height: 223}
#| id: 293aea4f-70a8-47de-9058-1baf160aef3d
#| outputId: 49dc76fc-f8f1-4d70-eac6-5903e2f92807
#| vscode: {languageId: r}
model_names <- c("Full Model", "AIC-selected Model", "BIC-selected Model", "LASSO Model")
AUC_values <- c(ROC_full_log$auc, ROC_AIC_log$auc, ROC_BIC_log$auc, as.double(AUC_lasso))
comparison_table <- data.frame(Model = model_names, AUC = AUC_values)

comparison_table
```

 ### Results:

 After comparing the AUC values for the four candidate models, we observed that the AIC-selected model had the best prediction performance on the training dataset. Consequently, we determined to adopt the AIC-selected model as our final predictive model. Next, we will assess the out-of-sample performance of our final model by applying it to the testing dataset, thereby generating the ROC curve and computing the corresponding AUC value.

```{r}
#| id: fd7d0833-490b-43bb-b78b-2ab6ca1f3f9e
#| colab: {base_uri: 'https://localhost:8080/', height: 895}
#| id: fd7d0833-490b-43bb-b78b-2ab6ca1f3f9e
#| outputId: ce5fe713-617d-4650-88cd-928db01f51c6
#| vscode: {languageId: r}
options(repr.plot.width = 15, repr.plot.height = 10)
model_X_test <- diabetes_test[, -which(names(diabetes_test) == "Outcome")]

predicted_prob_AIC <- predict(AIC_model, newdata = model_X_test, type = "response")
predicted_fullmodel <- predict(full_model, newdata = model_X_test, type = "response")
predicted_prob_BIC <- predict(BIC_model, newdata = model_X_test, type = "response")
predicted_lasso <- predict(diabetes_LASSO_1se_AUC, newx = as.matrix(model_X_test))[,"s0"]

ROC_AIC_model_in_testdata <- roc(response = diabetes_test$Outcome, predictor = predicted_prob_AIC)
plot(ROC_AIC_model_in_testdata,  print.auc = TRUE, print.auc.x = 0.5, print.auc.y = 0.5, col = "steelblue", lwd = 3, lty = 2, main = "ROC Curve of Models using Test Dataset", cex.main = 2)

ROC_full_model_in_testdata <- roc(response = diabetes_test$Outcome, predictor = predicted_fullmodel)
plot(ROC_full_model_in_testdata, print.auc = TRUE, print.auc.x = 0.5, print.auc.y = 0.45, col = "black", lwd = 3, lty = 2, add = TRUE)

ROC_BIC_model_in_testdata <- roc(response = diabetes_test$Outcome, predictor = predicted_prob_BIC)
plot(ROC_BIC_model_in_testdata, print.auc = TRUE, print.auc.x = 0.5, print.auc.y = 0.40, col = "springgreen", lwd = 3, lty = 2, add = TRUE)

ROC_lasso_in_testdata <- roc(response = diabetes_test$Outcome, predictor = predicted_lasso)
plot(ROC_lasso_in_testdata, print.auc = TRUE, print.auc.x = 0.5, print.auc.y = 0.35, col = "red", lwd = 3, lty = 2, add = TRUE)


legend("bottomright", legend = model_names, col = c("black", "steelblue", "springgreen", "red"), lty = 2, lwd = 3)
```

#### Result summary and conclusion:
Based on our analysis, the AIC-selected model has the best prediction performance among the four models we compared. Upon fitting the AIC-selected model to the testing dataset, we obtained an AUC value of 0.808, which underscores the robust predictive capability of our AIC-selected model when applied to out-of-sample data.

Therefore, we have concluded that the AIC-selected model aligns most effectively with our project's objective of establishing a predictive model for determining the probabilty of an individual having diabetes. Below is a summary of the selected model:

$$ \log\left(\frac{p_i}{1-p_i}\right) = -10.620170 + 1.146492 \space \text{DiabetesPedigreeFunction} + 0.040539 \space \text{Age} + 0.078362 \space \text{BMI} + 0.042436 \space \text{Glucose}$$ where $p_i$ is the probability of the $ i_{\text{th}}$ individual having diabetes.

Given an individual's diabetes percentage, age, BMI, and glucose level, this model can be used to predictive the probability of diabetes as
$$p_{i} = \frac{1}{1+e^{-(-10.620170 + 1.146492 \times \text{DiabetesPedigreeFunction} + 0.040539 \times \text{Age} + 0.078362 \times \text{BMI} + 0.042436 \times \text{Glucose})}}$$

## Discussion:

Through this project, we've developed a predictive model to estimate the probability of an individual having diabetes. In our final model, we've left with four key variables, making the model has the best prediction performance: DiabetesPedigreeFunction, Age, BMI, and Glucose. Notably, all coefficients associated with these variables are positive, indicating that higher values for these factors correlate with an increased prbability of diabetes. Following model comparison and selection processes, the AIC-selected model has been determined as the optimal choice, demonstrating best predictive performance both in-sample and out-of-sample prediction among our 4 candidate models with AUC value of approximately 0.8, indicating its robust predictive capabilities.

The outcome of our analysis was surprising. While AIC-based stepwise selection is commonly used to explore predictor-response relationships, we opted to assess the efficacy of a LASSO model, known for predictive power and overfitting avoidance. We expected the LASSO model to outperform the AIC-selected model in out-of-sample prediction accuracy. However, results showed the AIC-selected model not only offered good interpretability but also outperformed the LASSO model in terms of AUC values. This outcome is better than we expected as it signifies a balance between model interpretability and predictive powerness in our final model.

While the AIC-selected model performed best on the testing dataset, its superiority on out-of-sample data is not guaranteed. Implementing k-fold cross-validation and calculating CV-AUC values for our four candidate models can enhance our methodology. This approach assesses models across various data partitions, reducing reliance on chance results from a single train-test split. CV-AUC values may not always align with initial model selection; for instance, the Lasso model might show the highest CV-AUC value, indicating superior prediction performance. Integrating k-fold cross-validation into our model evaluation enhances our methodology's robustness, ensuring our final predictive model is well-suited for generalization to unseen data.

A key area for future exploration is identifying additional predictors beyond those in our dataset that could influence diabetes risk. Factors like other medical histories and pharmaceutical supplements may provide valuable insights. Additionally, we should investigate how different parameters, such as lambda values, affect the LASSO model's performance. In our analysis we use lambda.1se value, and explore the performance with the lambda.min value. In summary, exploring new predictors and optimizing regularization parameters can enhance our predictive models and improve our ability to predict and manage diabetes.


## References:


1. **Related Study 1**: Joshi, Ram D, and Chandra K Dhakal. “Predicting Type 2 Diabetes Using Logistic Regression and Machine Learning Approaches.” International Journal of Environmental Research and Public Health, U.S. National Library of Medicine, 9 July 2021, www.ncbi.nlm.nih.gov/pmc/articles/PMC8306487/.

2. **Related Study 2**: Chang, Victor, et al. “Pima Indians Diabetes Mellitus Classification Based on Machine Learning (ML) Algorithms.” Neural Computing & Applications, U.S. National Library of Medicine, 24 Mar. 2022, www.ncbi.nlm.nih.gov/pmc/articles/PMC8943493/.

3. **Data source:** National Institute of Diabetes and Digestive and Kidney Diseases. “Predict Diabetes.” Kaggle, 9 Nov. 2022, www.kaggle.com/datasets/whenamancodes/predict-diabities?resource=download.
4. **More Details on data:** “Pima Indians Diabetes Database - Dataset by Data-Society.” Data.World, 13 Dec. 2016, www.data.world/data-society/pima-indians-diabetes-database.
5. **ROC in health data:** Nahm, Francis Sahngun. “Receiver Operating Characteristic Curve: Overview and Practical Use for Clinicians.” Korean Journal of Anesthesiology, U.S. National Library of Medicine, Feb. 2022, www.ncbi.nlm.nih.gov/pmc/articles/PMC8831439/.

